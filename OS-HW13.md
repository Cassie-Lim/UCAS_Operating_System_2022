# OS作业13
<center>
    林孟颖 2020K8009915008
</center>
[TOC]

#### 13.1 
现有一个文件系统，它的文件块索引采用多级间址。该文件系统的inode，包含10个直接指针，1个一级间址指针，1个二级间址指针和1个三级间址指针。假设文件块大小为4KB，每个文件块对应的磁盘块地址为4B。

1) 请问该索引结构能够索引的最大文件是多大?

2) 请问一个 1GB 的文件需要几级间址?它总共有多少间址块?其中，各级间址块分别是多少? 如何找到第20,000块？

---

1. 文件块索引地址大小4B，一个文件块大小4KB，故一个索引块可以存放1K个文件块的索引地址，则其所能索引的最大文件大小为：
   $$
   2^{30}\times 4KB \times 1 \\
   + 2^{20}\times 4KB \times 1 \\
   + 2^{10}\times 4KB \times 1 \\
   + 4KB \times 10 = 4,299,165,736 KB
   $$
   
2. 

$$
1GB = 2^{10}\times 4KB \times 256
$$

1GB文件需要三级间址，其需要$2^{10} \times 256$个一级间址块，$256$个二级间址块，1个三级间址块，共计$ 2^{10} \times 256+ 256 +1= 263,425$个间址块；

对于第20,000块：
$$
20,000 ÷ 2^{10} \approx 19.5 \\
20,000 - 19 \times 2^{10} = 544
$$
故需要在三级间址块中取出第19个二级间址块的地址，索引到该二级间址块再取出第544个一级间址块的地址，据该地址可索引到第20,000个块。



#### 13.2 
某用户X刚挂载了一个文件系统（**假设此时该文件系统的所有inode已被加载到内存**），该文件系统使用的磁盘块大小为**4KB**，能用到的page cache大小最大为**512MB**。随后，该用户执行如下所示程序A。请分析（请写出分析过程）

1) 当程序A打开fs02.ppt文件时，文件系统需要从磁盘读取几个磁盘块？

2) 假设该文件系统采用**write through**的缓存策略，当程序A完成对fs02.ppt的写入操作后，文件系统写入几个磁盘块？如果该文件系统采用的是write back缓存策略，那么程序A在写完fs02.ppt还未关闭文件时，文件系统写入几个磁盘块？

3) 程序A执行完成后，用户Y再次运行该程序，当程序A打开fs02.ppt时，文件系统需要从磁盘读取几个磁盘块？ 

4) 用户Y将程序A中打开的文件修改为/home/os22/fs01.ppt，并编译执行程序A，那么当程序A打开fs01.ppt时，文件系统需要从磁盘读取几个磁盘块？

注：假设（1）**所有目录都只需1个磁盘块保存其内容**；（2）fs01.ppt和fs02.ppt两个文件**已在文件系统中存在**。

程序A代码如下

```c
#define MAX (1024)

char buf[MAX];

int fd = open("/home/os22/fs02.ppt", O_CREAT | O_RDWR, 0666); 

int n=0, i=0;

if (fd < 0 ) {

    perror("open");

    exit(-1); 

}

for (i = 0; i < MAX; i++) {

    bzero(buf, sizeof(buf)); 

    sprintf(buf, "%3d\n", i);

    n = write(fd, buf, strlen(buf)); 

    printf("len=%d\n", strlen(buf)); 

    if (n != strlen(buf)){

    	perror("write");

    printf("length=%d, buf=[%s]", strlen(buf), buf);

}} 

close(fd);
```

---

1. 系统打开文件fs02.ppt时，需要先在含有文件a的目录项中查找其inode号，为此需要确保其对应目录项已经在内存中，由于inode已经全部载入内存，其只需要依次读入`/`、`home`、`os22`对应目录数据的块，故共需要读取3个磁盘块。


2. 若采用write through策略，该过程向文件写入1024 x 1024B / 4KB = 256（块），故需要向磁盘写256块；

   若采用write back策略，由于写的时候只需要1MB的内存，过程中无需替换page cache，故在关闭文件之前无需写磁盘块。


3.  当程序再次运行时，其前几级目录对应的磁盘块已经被载入内存，存放于page cache中，故无需读取磁盘块。


4.  若在打开完fs02.ppt后再次打开`/home/os22/fs01.ppt`，由于其父目录对应的内容块都已经存在page cache中，只需在其目录项中查找即可，无需再额外读取磁盘块。



