# OS作业15
<center>
    林孟颖 2020K8009915008
</center>
[TOC]

### 15.1 

LFS 的imap和CR都采用类似数组的结构，下标是ino或imap块号，每一项保存对应i-node或imap块的磁盘地址。例如， imap[k]记录ino为k的i-node的磁盘地址；CR[n]记录第n个imap块的磁盘地址。假设一个LFS的块大小为 4KB，磁盘地址占4B。如果已经分配了200万个i-node，请问：

1) 该LFS的imap有多少个块？请给出计算过程;

2) 该LFS的CR有多少个块？请给出计算过程;

3) 如何查ino=654321的inode的磁盘地址？请给出查找和计算过程。

---

1. 据LFS特性，已经分配了200万个inode，则应该有200万个对应的imap，由于imap记录的是inode在磁盘中的地址，故一个imap记录所占空间为4B，因而有其占用：
   $$
   \lceil\frac{2\times 10^{6}\times 4B}{4KB} \rceil=  1953（块）
   $$

2. CR数组含200万项以记录200万个imap在磁盘中的地址，其每项大小依旧是4B，故其也占据1953块。

3. 对于ino=654321的inode，其对应下标为654321的imap项，该imap项由下标为654321的CR项定位，读磁盘的最小粒度为一个sector（512B）其中
   $$
   \lfloor \frac{654321\times 4B}{4KB} \rfloor = 638
   $$
   故其在CR起始block处算起第638个块中，且其在块内的offset为：
   $$
   654321 - 638 \times 4KB/4B =1009
   $$
   故磁头先移到从CR起始块开始计数的第638个块，将该块读入内存后再取其中存储的第1009个地址，可得到对应imap的地址，从磁盘中读取imap中存储的数据（inode地址）可索引到ino=654321的inode所在磁盘位置。

 

### 15.2 

一个LFS的块大小为4KB，segment大小是4MB。文件块采用多级索引，即包含10个直接指针，以及一、二、三级间接指针各1个。每个指向数据块的指针占4字节。该 LFS 中已经有一个10MB的文件foo，请分析：

1) 给出文件 foo 的文件块索引结构，即文件foo使用了哪些指针？

2) 写文件 foo 的第 2560 块(假设它在磁盘块 Ai 中，Ai 为磁盘逻辑块号)，需要写哪些块？需要几次I/O？请给出它们写在磁盘上的顺序；
3) 如果是 Fast FS (其块大小也为 4KB)，写文件 foo 的第 2560 块，需要写哪些块? 需要几次I/O？

4) 如果是日志文件系统，只记录元数据日志，且**日志不采用批量提交**，则写文件 foo 的第 2560 块，需要写哪些块？需要几次 I/O？

---

1. 
   - 一个直接指针可以索引的数据块大小总为$4KB$，10个直接指针可索引的范围为$40KB <10MB$
   - 一个一级间接指针可索引的范围为$4KB/4B \times 4KB = 4MB$，$ 40KB+4MB<10MB$;
   - 一个二级间接指针可索引的范围为$4KB/4B \times 4KB/4B \times 4KB = 4GB$，$ 40KB+4MB+4GB>10MB$，故foo文件使用了10个直接索引指针、一个一级间接指针、一个二级间接指针。

2. 该文件原本已经占据了$10MB/4KB = 2560$块，该次写第2560块的操作无需再给文件分-配额外的块（即无需修改data bitmap）。该块由二级间接指针索引。为写该块内容，需要先：
   
   - 读取inode：CR→imap→inode，需要3次IO
   
   - 读取该块地址：读入二级间址块、一级间址块，需要两次IO
   
   - 写该块：
   
     由于每次写文件块都需要修改inode并追加到数据块后，而每次写后都需在inode后再追加imap的信息，则**一共要写第Ai，Ai+1，Ai+2块**。由于几个块连续，且其大小总和不超过一个segment，实际上可以连续写入，故只需要一次IO。
   
     **共计6次IO**。
   
   待修改块在磁盘中的顺序如下：
   
   | Ai     | Ai+1    | Ai+2   |
   | ------ | ------- | ------ |
   | 数据块 | inode块 | imap块 |
   
3. FastFS需要写数据块、inode块和imap块。

   要写该块，需要先读入：

   - 读入inode：需要1次IO；
   - 读取该块地址：读入二级间址块、一级间址块，需要2次IO；
   - 写该块：1次IO；修改该块后需要修改对应inode中的时间戳等信息，1次IO。

   共计5次IO。

4. 首先需要修改数据块，由于采用元数据日志，则只需要依次记录inode块信息，同时在写入inode块信息前需要先写入TxB，写完元数据块后还需再写入TxE块。

   - 读入inode：需要1次IO；
   - 读取该块地址：读入二级间址块、一级间址块，需要2次IO；
   - 写该块：1次IO；
   - 写TxB，1次IO；写inode块信息，1次IO；写TxE，1次IO。

   由于日志不批量提交，该次写操作进行完后就需将日志中的更新落盘：

   - 修改inode，1次IO;
   - 删除日志块，由于日志块的内容在磁盘中连续，只需要1次IO。

   共计9次IO。

> 参考资料：
>
> [传统的文件系统--FFS和LFS (slidestalk.com)](https://www.slidestalk.com/u231/file_system_computer)
>
> [操作系统基础 - LFS和SSD - 腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1673101)

