# OS作业14
<center>
    林孟颖 2020K8009915008
</center>
[TOC]

#### 14.1 

现有一个文件系统，在其使用文件缓存的情况下，某个应用创建了一个文件 “/home/OS22/fs03.pdf”，并往该文件中写入了4 KB的数据，请分析该过程需要写几个块?分别写哪几个块? 如果在任意时刻发生宕机，会出现哪些不一致?请详细列出所有不一致的情况。（注：假设home和OS22目录都已存在）

---

home、OS22目录已经存在，无需再额外分配块并写块，创建fs03.pdf分为以下几个步骤：

- 给`fs03.pdf`分配一个inode，需要修改inode所在的块以及inode bitmap对应块；
- 在OS22对应inode索引的某一块内创建`fs03.pdf`的目录项，需要修改一块；
- 给`fs03.pdf`分配一块，并令其对应inode的索引域指向之，同时向内写入4KB数据，为此需要写data block和其对应的bitmap；

综上共计5块。

如果发生宕机，可能会出现如下不一致：

- FS不一致：
  - 文件对应inode与data block的bitmap没有同时写回；
  - inode与inode的bitmap没有同时写回；
- 数据与元数据不一致：
  - inode或间址块未和数据块一同写回；
- 数据不一致
  - 该写操作包含多个扇区，而一次磁盘读写是以sector为单位，故有可能出现数据未完全写入data block的情况。

 

 

#### 14.2 

某个文件系统在磁盘上保存了一个大小为20 KB的文件A，现有一个进程打开文件 A，并调用**write函数一次性向文件 A 的文件块0 和文件块1写入新数据**。假设该文件系统使用文件缓存，且宕机可能发生在任意时刻。请分析

1) 如果文件系统采用数据日志，宕机恢复后，文件A的内容是什么?请分不同情况讨论(即在什么样的宕机情况下，文件A的内容是什么);

2) 如果文件系统采用元数据日志，并且采用先改数据再改元数据的方式，宕机恢复后，文件 A 的内容是什么?请分不同情况讨论(即在什么样的宕机情况下，文件 A 的内容是什么)。

---

1. 采用数据日志，会同时记录元数据修改情况和data block的修改内容：

   - 若在数据日志提交（commit）前发生宕机，则恢复后A的数据为最初的状态；
   - 若在commit后发生宕机，则在checkpoint处可根据日志内容完复刻该次写操作，A的文件块0和1都发生相应改变；

2. 元数据日志只记录修改的元数据信息，由于先修改元数据，则情况可能如下：

   - 在尚未写入如何数据块的情况宕机，则不会有元数据的记录，A的内容也不会发生变化；
   - 写入了数据块0时发生宕机，由于此时还未写完数据块，不会进行元数据的日志记录，故恢复后A的数据依旧只修改了数据块0；
   - 写入数据块0，1后才发生宕机，无论是否进行了元数据日志的记录，A的内容中文件块0，1都发生变化。

   > 由于读取文件时实际上需要以元数据做索引，而对于文件A，其原本已经分配了20KB，我们修改的数据块0，1已经有对应的元数据记录，故即使没有元数据的更新，我们依旧能索引到该两块的内容，只是inode中mtime、atime等对应信息不准确。
